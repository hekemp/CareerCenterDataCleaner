<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Data Cleaner</title>
  <meta name="description" content="Pomerantz Career Center Data Cleaner">
  <meta name="author" content="Pomerantz Career Center">


  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

  <link rel="stylesheet" href="css/styles.css">


</head>


<body>

<script>
  // Check for the various File API support.
  if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
  } else {
    alert('The File APIs are not fully supported in this browser.');
  }
</script>

<img src="images/Banner.png" class="banner" alt="Data Cleaner">

    <div class="content">

      <h3>Instructions</h3>
      <button class="accordion">Getting Set Up</button>
          <div class="panel">
            <ul style="list-style-type:circle">
              <li>Coffee</li>
              <li>Tea</li>
              <li>Milk</li>
              <li>Milk</li>
            </ul>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
          </div>

          <button class="accordion">Starting The Cleaning Process</button>
          <div class="panel">
            <ul style="list-style-type:circle">
              <li>Coffee</li>
              <li>Tea</li>
              <li>Milk</li>
              <li>Milk</li>
            </ul>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
          </div>

          <button class="accordion">Additional Cleaning Information</button>
          <div class="panel">

            <ul style="list-style-type:circle">
              <li>You can continue to clean your input file by typing in a new column and then hitting "Start Cleaning" again.</li><br/>
              <li>When you click start cleaning, all matchings from the keys file (and any other matches made in previous cleanings during this file session) will be applied instantly.</li><br/>
              <li>So long as you do not upload a new input file or key file, the matches that you've made will remain during your current session. Changing the file(s) will reset the information for that category. For example, updating your input file will reset what's read in to change, but will not reset your key-value pairs. Be sure to download your changed files before uploading a new one.</li><br/>
              <li>If you make a mistake and want to start over again with the same data file, just reupload that file and key file and click "Start Cleaning" again.</li>
            </ul>
          </div>

          <button class="accordion">Saving Your Files</button>
          <div class="panel">
            <ul style="list-style-type:circle">
              <li>Type the name of the file you wish to save your cleaned data into (without the extension) in the "New File Name" box. For example, if I want the file "2018 Data.csv", I would type "2018 Data" into the "New File Name" box, and then click "Download New File". The file will then be downloaded to your Downloads folder, or a window will prompt you to do so, depending on your browser.</li><br/>
              <li>Type the name of the file you wish to save your updated key-value pairs into (without the extension) in the "Updated Key File Name" box. For example, if I want the file "2018 Data Keys.csv", I would type "2018 Data Keys" in the "Updated Key File Name" box, and then click "Download Key File".</li>
            </ul>
            <p></p>
            <p></p>
          </div>

          <p> <b>Reminder:</b> Be sure to save your new data file and updated key file after you finish cleaning the data. Your uploaded files <i>are not changed</i> and your changes are not kept between sessions.</p>

          <script>
          var acc = document.getElementsByClassName("accordion");
          var i;

          for (i = 0; i < acc.length; i++) {
              acc[i].addEventListener("click", function() {
                  this.classList.toggle("active");
                  var panel = this.nextElementSibling;
                  if (panel.style.display === "block") {
                      panel.style.display = "none";
                  } else {
                      panel.style.display = "block";
                  }
              });
          }
          </script>


      <div class="row">
            <div class="col-xs-4 col-sm-4 col-md-4">
              <div class ="form-group">
                <label>Input File</label>
                <input type="file" id="files" name="file" />
                <small id="inputHelp" class="form-text text-muted">Accepted File Types: .csv</small>
                <button type="button" class="btn btn-primary btn-block" onclick="resetInput();">Restore to file contents</button>
              </div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4">
              <div class ="form-group">
                <label>Key File</label>
                <input type="file" id="keys" name="key" />
                <small id="keysHelp" class="form-text text-muted">Accepted File Types: .csv</small>
                <button type="button" class="btn btn-primary btn-block" onclick="resetKeys();">Restore to key file contents</button>
              </div>
            </div>
            <div class="col-xs-4 col-sm-4 col-md-4">
              <div class ="form-group">
                <label>Column to Clean</label>
                <input type="text" name="ColumnToChange" id="ColumnToChange" value="">
                <small id="nameHelp" class="form-text text-muted">Use the formating from Excel for your input file (Ex. A, B, AA, or AB)</small>
              </div>
            </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div id="progress_bar"><div class="percent">0%</div></div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
              <button type="button" class="btn btn-primary btn-block" onclick="startCleaning();">Start Cleaning</button>
              <p class="error" id="errorMessage">&nbsp;</p>
          </div>
        </div>


<script>
  var reader;
  var progress = document.querySelector('.percent');

  var readText;
  var keyText;
  var columnChanging;

  var readInList = [];
  var keyInList = [];

  var foundKeyValues = {};
  var toAssign = {};
  var index = 0;

  var cleaningStarted = false;

  var names;

  function strCompare(a, b) { // Removes speical characters, staring and ending spaces, and extra spaces for ignoring case comparison
    let s1 = a.replace(/[^A-Za-z0-9\s]/g, "").replace(/\s*/g, " ").toLowerCase().trim();
    let s2 = b.replace(/[^A-Za-z0-9\s]/g, "").replace(/\s*/g, " ").toLowerCase().trim();
    return s1.localeCompare(s2);
  }

  function resetKeys(){
    if(keyText != null){
      document.getElementById("errorMessage").innerHTML = "&nbsp;"
      breakKeyText();
      if(cleaningStarted){
        startCleaning();
      }
    }
    else{
      document.getElementById("errorMessage").innerHTML = "No key file was uploaded."
    }

  }

  function resetInput(){
    if(readText != null){
      document.getElementById("errorMessage").innerHTML = "&nbsp;"
      breakReadText();
      if (cleaningStarted) {
        startCleaning();
      }
    } else {
      document.getElementById("errorMessage").innerHTML = "No input file was uploaded."
    }


  }

  function abortRead() {
    reader.abort();
  }

  function errorHandler(evt) {
    switch(evt.target.error.code) {
      case evt.target.error.NOT_FOUND_ERR:
        document.getElementById("errorMessage").innerHTML = "File was not found.";
        break;
      case evt.target.error.NOT_READABLE_ERR:
        document.getElementById("errorMessage").innerHTML = "File was not able to be read.";
        alert('File is not readable');
        break;
      case evt.target.error.ABORT_ERR:
        break; // noop
      default:
        document.getElementById("errorMessage").innerHTML = "There was an error reading this file.";
    };
  }

  function updateProgress(evt) {
    // evt is an ProgressEvent.
    if (evt.lengthComputable) {
      var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
      // Increase the progress bar length.
      if (percentLoaded < 100) {
        progress.style.width = percentLoaded + '%';
        progress.textContent = percentLoaded + '%';
      }
    }
  }

  function handleKeysSelect(evt) {
    // Reset progress indicator on new file selection.
    progress.style.width = '0%';
    progress.textContent = '0%';

    reader = new FileReader();
    reader.onerror = errorHandler;
    reader.onprogress = updateProgress;
    reader.onabort = function(e) {
      document.getElementById("errorMessage").innerHTML = "File read was cancelled";
    };
    reader.onloadstart = function(e) {
      document.getElementById('progress_bar').className = 'loading';
    };
    reader.onload = function(e) {
      // Ensure that the progress bar displays 100% at the end.
      progress.style.width = '100%';
      progress.textContent = '100%';
      setTimeout("document.getElementById('progress_bar').className='';", 2000);


      keyText = reader.result;
      breakKeyText();


    }



    // Read in the image file as a binary string.
    reader.readAsText(evt.target.files[0]);



  }

  function handleFileSelect(evt) {
    // Reset progress indicator on new file selection.
    progress.style.width = '0%';
    progress.textContent = '0%';

    reader = new FileReader();
    reader.onerror = errorHandler;
    reader.onprogress = updateProgress;
    reader.onabort = function(e) {
      document.getElementById("errorMessage").innerHTML = "File read was cancelled";
    };
    reader.onloadstart = function(e) {
      document.getElementById('progress_bar').className = 'loading';
    };
    reader.onload = function(e) {
      // Ensure that the progress bar displays 100% at the end.
      progress.style.width = '100%';
      progress.textContent = '100%';
      setTimeout("document.getElementById('progress_bar').className='';", 2000);


      readText = reader.result;
      breakReadText();

    }



    // Read in the image file as a binary string.
    reader.readAsText(evt.target.files[0]);



  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  document.getElementById('keys').addEventListener('change', handleKeysSelect, false);



  //download(reader.result, "test", "text/csv");

  function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
      }
    }

    var mapLetterValue = function(val) {
      var base = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', i, j, result = 0;

      for (i = 0, j = val.length - 1; i < val.length; i += 1, j -= 1) {
        result += Math.pow(base.length, j) * (base.indexOf(val[i]) + 1);
      }

      return result;
    };

    function isEmpty(ob){
        for(var i in ob){ return false;}
      return true;
    }

    function startCleaning(){

      foundKeyValues = {};
      toAssign = {};
      index = 0;
      cleaningStarted = true;

      names = [];

      var columnToChange = document.getElementById("ColumnToChange").value;
      columnToChange = columnToChange.toUpperCase();

      columnChanging = [ columnToChange ].map(mapLetterValue)[0] - 1;

      if(readText == null){
        document.getElementById("errorMessage").innerHTML = "No input file was uploaded."
      }
      else if (keyText == null) {
        document.getElementById("errorMessage").innerHTML = "No key file was uploaded."
      } else if (columnToChange == "") {
        document.getElementById("errorMessage").innerHTML = "No column to clean was selected."

      } else {

        document.getElementById("errorMessage").innerHTML = "&nbsp;"
        var currentValue;
        for(var i = 1; i < readInList.length; i++) {
          currentValue = readInList[i][columnChanging];

          if (currentValue == ""); // empty column
          else if ((foundKeyValues[currentValue] != "" && foundKeyValues[currentValue] != null )) { // we already know the value
            readInList[i][columnChanging] = foundKeyValues[currentValue];
          } else {
              var locatedValue = findValue(currentValue);

              if (locatedValue != ""){ // Item was assigned a value
                foundKeyValues[currentValue] = locatedValue;
                readInList[i][columnChanging] = locatedValue;
              }
              else { // Item hasn't been assigned yet
                if(toAssign[currentValue] != "" && toAssign[currentValue] != null) { // Item has been found elsewhere
                  toAssign[currentValue][toAssign[currentValue].length] = i;
                }
                else { // This is the first time we've found this item
                  toAssign[currentValue] = [ i ];
                }
              }
          }
        }
        assignKeysToNames();

        if(isEmpty(toAssign)){
          $("#name-chooser").text("Cleaning complete!");
        }
        else{
          $("#name-chooser").text(names[0]);
          populateChoices();
        }
      }
    }

    /*
      To Get Items:
      for(item in toAssign){
        console.log(toAssign[item]);
      }
    */

    function assignKeysToNames(){
      names = [];
      for(item in toAssign){
        names[names.length] = item;
      }
    }

    function nextChoice(companyPicked) {

      document.getElementById("errorMessage").innerHTML = "&nbsp;"
      var newIndex;
      for(var i = 0; i < toAssign[names[index]].length; i++){
        newIndex = toAssign[names[index]][i];
        readInList[newIndex][columnChanging] = companyPicked;
      }

      for(var i = 0; i < keyInList.length; i++){
        if(strCompare(keyInList[i][0], companyPicked) == 0){
          keyInList[i][keyInList[i].length] = names[index];
          i = keyInList.length;
        }
      }

      if(index < names.length - 1) {
        index++;
        $("#name-chooser").text(names[index]);
        document.getElementById("customInput").value  = "";
      } else {
        $("#name-chooser").text("You're Done!");
        toAssign = {}
        index = 0;
        document.getElementById("choices").innerHTML = "";
        document.getElementById("custom").innerHTML = "";
        document.getElementById("instruction").innerHTML = '<h3 id="instruction" class="text-muted">Download your files now, or continue cleaning.</h3>';

      }

      return false;
    }

    function nextChoiceAdd() {

      document.getElementById("errorMessage").innerHTML = "&nbsp;"
      var theirValue = document.getElementById("customInput").value;
      keyInList[keyInList.length] = [ theirValue ];
      populateChoices();

      var newIndex;
      for(var i = 0; i < toAssign[names[index]].length; i++){

        newIndex = toAssign[names[index]][i];
        readInList[newIndex][columnChanging] = theirValue;
      }

      if(index < names.length - 1) {
        index++;
        $("#name-chooser").text(names[index]);
      } else {
        $("#name-chooser").text("You're Done!");
        toAssign = {}
        index = 0;
        document.getElementById("choices").innerHTML = "";
        document.getElementById("custom").innerHTML = "";
        document.getElementById("instruction").innerHTML = '<h3 id="instruction" class="text-muted">Download your files now, or continue cleaning.</h3>';
      }

      document.getElementById("customInput").value  = "";

      return false;
    }

    function populateChoices(){
      document.getElementById("choices").innerHTML = "";
      var sortedKeys = keyInList.slice().sort(function (a, b) {
        return strCompare(a[0], b[0]);
      });
      for(var i = 0; i < sortedKeys.length; i++){
        if(sortedKeys[i][0] != ""){
          document.getElementById("choices").innerHTML += '<div class="form-group" style="padding:1% 3% .25% 3%"><button class="btn" onclick="return nextChoice(\'' + sortedKeys[i][0] + '\');">' + sortedKeys[i][0] + '</button></div>';
        }

      }

      document.getElementById("custom").innerHTML = '<div class="form-group"><label for="customInput">Company Name:</label><input type="text" class="form-control" id="customInput" placeholder="New company name" onInput="displayFilteredChoices()" /></div><button class="btn btn-primary" onclick="return nextChoiceAdd();">Submit</button>';
      document.getElementById("instruction").innerHTML = '<h3 id="instruction" class="text-muted">Select a canonical company name:</h3>';
    }

    function substringComparison(a, b, chars){

      if(chars > b.length){ // if a is longer than b, it can't be b
        return false;
      }
      if (a.trim().length != a.length){ // Handles surrounding white spaces that might have slipped by
        chars = a.trim().length;
      }

      let s1 = a.replace(/[^A-Za-z0-9\s]/g, "").replace(/\s*/g, "").toLowerCase().trim().substring(0, chars);
      let s2 = b.replace(/[^A-Za-z0-9\s]/g, "").replace(/\s*/g, "").toLowerCase().trim();

      return s2.includes(s1);
    }

    function displayFilteredChoices(){
      document.getElementById("choices").innerHTML = "";
      var theirValue = document.getElementById("customInput").value;
      var filteredKeys = [];
      for (var i = 0; i < keyInList.length; i++){
        if(substringComparison(theirValue, keyInList[i][0], theirValue.replace(/[^A-Za-z0-9\s]/g, "").replace(/\s*/g, "").trim().length)){
          filteredKeys[filteredKeys.length] = keyInList[i][0];
        }
      }
      var sortedKeys = filteredKeys.slice().sort(function (a, b) {
        return strCompare(a, b);
      });
      for(var i = 0; i < sortedKeys.length; i++){
        if(sortedKeys[i] != ""){
          document.getElementById("choices").innerHTML += '<div class="form-group" style="padding:1% 3% .25% 3%"><button class="btn" onclick="return nextChoice(\'' + sortedKeys[i] + '\');">' + sortedKeys[i] + '</button></div>';
        }

      }

      document.getElementById("instruction").innerHTML = '<h3 id="instruction" class="text-muted">Select a canonical company name:</h3>';
    }


    function findValue(itemToLocate){

      for(var i = 0; i < keyInList.length; i++) {
        for(var j = 0; j < keyInList[i].length; j++){
          if (strCompare(keyInList[i][j], itemToLocate) == 0){
            return keyInList[i][0];
          }
        }
      }
      return "";
    }

    function breakReadText(){

      var splitByLine = readText.split(/\r?\n/g);
      var splitByComma = [];
      for(var i = 0; i < splitByLine.length; i++){
        splitByComma[i] = splitByLine[i].split(',');

      }
      readInList = splitByComma;

    }

    function breakKeyText(){
      var splitByLine = keyText.split(/\r?\n/g);
      var splitByComma = [];
      for(var i = 0; i < splitByLine.length; i++){
        splitByComma[i] = splitByLine[i].split(',');

      }
      keyInList = splitByComma;

    }

    function reassembleReadText(){
      var splitByLine = [];
      for(var i = 0; i < readInList.length; i++){
        splitByLine[i] = readInList[i].join(',');
      }
      return splitByLine.join('\n');
    }

    function reassembleKeyText(){
      var splitByLine = [];
      for(var i = 0; i < keyInList.length; i++){
        splitByLine[i] = keyInList[i].join(',');
      }
      return splitByLine.join('\n');

    }

    function downloadFile(){


      var fileName = document.getElementById("FileName").value;

      if(fileName == ""){
        document.getElementById("errorMessage").innerHTML = "No input file was uploaded.";
      } else if ( readInList == [] || readInList == null ) {
        document.getElementById("errorMessage").innerHTML = "No input file was uploaded.";
      }
      else {
        document.getElementById("errorMessage").innerHTML = "&nbsp;";
        var newText = reassembleReadText();
        download(newText, fileName, "text/csv");
      }
    }

    function downloadKeyFile(){
      var fileName = document.getElementById("KeyFileName").value;
      if(fileName != "" && ( keyInList != [] && keyInList != null ) ) {
        var newText = reassembleKeyText();
        download(newText, fileName, "text/csv");
      }
    }

</script>

<div class="container">
  <form>
    <h1 id="name-chooser"></h1>
    <h3 id="instruction" class="text-muted"></h3>
    <div id="choices" class="choicesBox">

    </div>
    <div id="custom">

    </div>
  </form>
</div>

<div class="row">
  <div class="col-xs-6 col-sm-6 col-md-6">
    <div class ="form-group">
      <label>New File Name: </label>
      <input type="text" name="FileName" id="FileName" value="">.csv
    </div>
  </div>
  <div class="col-xs-6 col-sm-6 col-md-6">
    <div class ="form-group">
      <button onclick="downloadFile();">Download New File</button><br>
      <small id="fileHelp" class="form-text text-muted">When you click this button, a file with the name you specified in "New File Name" will be saved to your Downloads folder.</small>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-xs-6 col-sm-6 col-md-6">
    <div class ="form-group">
      <label>Updated Key File Name: </label>
      <input type="text" name="KeyFileName" id="KeyFileName" value="">.csv
    </div>
  </div>
  <div class="col-xs-6 col-sm-6 col-md-6">
    <div class ="form-group">
      <button onclick="downloadKeyFile();">Download Key File</button>
      <small id="fileHelp2" class="form-text text-muted">When you click this button, a file with the name you specified in "Updated Key File Name" will be saved to your Downloads folder.</small>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</div>

</body>
</html>
